<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Login com Google</title>
</head>
<body style="display:flex;align-items:center;justify-content:center;height:100vh;">
  <button id="login-btn" style="font-size:1.2em;padding:0.5em 1em;">
    Login com Google
  </button>

  <script>
    const clientId    = "{{ GOOGLE_OAUTH2_CLIENT_ID }}";
    const redirectUri= window.location.origin + "/login-callback/";
    const scope      = "openid email profile";
    const nonce      = Math.random().toString(36).substring(2);

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/sw.js')
        .then(() => console.log('Service Worker registrado.'))
        .catch(console.error);
    }

    document.getElementById('login-btn').addEventListener('click', () => {
      const authUrl = 
        'https://accounts.google.com/o/oauth2/v2/auth' +
        '?response_type=id_token' +
        '&client_id=' + encodeURIComponent(clientId) +
        '&redirect_uri=' + encodeURIComponent(redirectUri) +
        '&scope=' + encodeURIComponent(scope) +
        '&nonce=' + encodeURIComponent(nonce);
      window.open(authUrl, 'google_login', 'width=500,height=600');
    });

    window.addEventListener('message', async event => {
      if (event.origin !== window.location.origin) return;
      if (event.data && event.data.type === 'ID_TOKEN') {
        const idToken = event.data.idToken;
        try {
          const res = await fetch('/api/auth/google/', {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ id_token: idToken })
          });
          const data = await res.json();
          if (!res.ok) throw data;
          const sw = await navigator.serviceWorker.ready;
          sw.active.postMessage({ type:'SET_JWT', token: data.token });
          window.location.href = '/swagger/';
        } catch (err) {
          console.error('Erro autenticando:', err);
          alert('Falha na autenticação: ' + (err.detail || err));
        }
      }
    });
  </script>
</body>
</html>